<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <script src="./vendor/snap.svg.js"></script>
    <script src="./dist/snappy-diagram.js"></script>
    <link href="./dist/snappy-diagram.css" media="all" rel="stylesheet" type="text/css">
    <style>
      .flex{
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .flex-row{
        flex-direction: row;
      }
      .flex-center{
        justify-content: center;
      }
      .flex-around {
        justify-content: space-around;
      }
      .flex-item-1{
        flex: 1;
      }
      .svg-wrap {
        margin-left: 100px;
        margin-right: 50px;
        height: 90%;
        padding: 10px;
      }
      .tool-wrap {
        width: 100px;
        height: 80%;
        background:#b346b1;
      }
      .modal {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
      }
      .modal .content {
        padding: 10px;
        background: white;
      }
      .show {
        z-index: 99;
      }
      .app {
        position: relative;
      }

      .btn {
        color: white;
        font-size: 15px;
      }
      .btn:hover {
        cursor: pointer;
        color: #39c5c9;
      }
      * {
        margin:0;
        padding: 0;
      }
      span, p, tspan {
        -moz-user-select: none; /*火狐*/
        -webkit-user-select: none; /*webkit浏览器*/
        -ms-user-select: none; /*IE10*/
        -khtml-user-select: none; /*早期浏览器*/
        user-select: none;
      }

    </style>
    <title>svg</title>
  </head>
  <body>
    <div class="flex flex-row app">
      <div class="tool-wrap flex flex-around">
        <div class="btn">
          <span id="node1">节点一</span>
        </div>
        <div class="btn">
          <span id="node2">节点二</span>
        </div>
        <div class="btn">
          <span id="node3">节点三</span>
        </div>
        <div class="btn">
          <span id="udtext">修改文本</span>
        </div>
        <div class="btn">
          <span id="togmod">更换模式</span>
        </div>
      </div>
      <div class="flex-item-1 svg-wrap">
        <svg id="my" width="100%" height="100%"/></svg>
      </div>
      <div class="modal flex flex-center">
        <div class="content flex flex-row">
          <label>修改：</label><input id="modal_input" type="text" />
        </div>
      </div>
    </div>

    <script>
      let win_w = document.documentElement.clientWidth || document.body.clientWidth;
      let win_h = document.documentElement.clientHeight || document.body.clientHeight;
      let app = document.querySelector(".app");
      let svgStage = document.querySelector("#my");
      let modal = document.querySelector(".modal");
      let modal_text = document.getElementById("modal_input");
      let toolWrap = document.querySelector(".tool-wrap");
      let initCell = {w: 0, h: 0};

      app.style.width = win_w + 'px';
      app.style.height = win_h + 'px';


      modal_text.addEventListener("keydown",function(e){
        let text;
        if(e.keyCode === 13) {
          text = modal_text.value;
          modal_text.value = "";
          modal.classList.remove("show");
          setTimeout(function(){
            addText(diagram.selected ,text)
          }, 50);
        }
        console.log(e);
      })

      toolWrap.addEventListener("click",function(e){
        console.log(e);
        switch (e.target.id) {
          case "node1":
            addnew().addText("开始").addImg("./start.png");
            diagram.draw();
            break;
          case "node2":
            addnew().addText("过程").addImg("./start.png");
            diagram.draw();
            break;
          case "node3":
            addnew().addText("结束").addImg("./start.png");
            diagram.draw();
            break;
          case "udtext":
            if(diagram.selected)
              showInput();
            break;
          case "togmod":
            toogleDrag();
            break;
          default:
            ;
        }

      })


      /* 重写draw方法 保证每次调用时 清空当前SVG */
      let o = SnappyDiagram.prototype.draw;
      SnappyDiagram.prototype.draw = function() {
        this.snap.clear();
        o.call(this);
      };

      function getCellShape() {
        let cellH, cellW;
        cellH = Math.floor(svgStage.clientHeight / 15);
        cellW = ~~(cellH * 3.5);
        initCell.w = cellW;
        initCell.h = cellH;
      }

      function showInput() {
        modal.classList.add("show");
        modal_text.focus();
      }


      /* ****************   一些操作接口   ********************* */
      function addnew (shape, options) {
        let cell;
        cell = diagram.addBox(0, 0, { attrs: {width:initCell.w, height: initCell.h} });
        if(diagram.options.allowDrag){
          diagram.draw();
        }else {
          toogleDrag();
        }
        return cell;
      }

      function toogleDrag () {
        diagram.options.allowDrag = !diagram.options.allowDrag;
        diagram.draw();
      }

      function addText(cell, text) {
        cell.addText(text);
        diagram.draw();
        return cell;
      }

      function delText(cell) {
        cell.delText();
        diagram.draw();
        return cell;
      }

      function addImg(cell, imgUrl) {
        cell.addImg(imgUrl);
        diagram.draw();
        return cell;
      }

      function delImg(cell) {
        cell.delImg();
        diagram.draw();
        return cell;
      }


      diagram = new SnappyDiagram({ el: "#my", width: 175, height: 50, allowDrag: false})
      getCellShape();
      // diagram.snap.attr('viewBox', `0 0 ${win_w} ${win_h}`);
      // diagram.snap.attr('width', `100%`);
      // diagram.snap.attr('height', `100%`);
    </script>
  </body>
</html>
